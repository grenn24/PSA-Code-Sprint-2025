{"version":3,"file":"websocket.js","sourceRoot":"","sources":["../../controllers/websocket.ts"],"names":[],"mappings":"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","sourcesContent":["import { WebsocketMessage } from \"@common/types/http.js\";\r\nimport WebSocket from \"ws\";\r\nimport wbService from \"../services/wb.js\";\r\nimport websocketService from \"../utilities/websocket.js\";\r\nimport chatService from \"../services/chat.js\";\r\n\r\nclass WebsocketController {\r\n\tasync postMessage(websocket: WebSocket, message: WebsocketMessage) {\r\n\t\tconst onDelta = (chunk: string) =>\r\n\t\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\t\ttype: \"wb_stream_chunk\",\r\n\t\t\t\tdata: chunk,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t\tconversationID: message.conversationID,\r\n\t\t\t});\r\n\t\tconst response = await wbService.postMessage(\r\n\t\t\tmessage.conversationID,\r\n\t\t\tmessage.data,\r\n\t\t\tonDelta\r\n\t\t);\r\n\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\ttype: \"wb_stream_end\",\r\n\t\t\tdata: response,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\tconversationID: message.conversationID,\r\n\t\t});\r\n\t}\r\n\r\n\tasync postMessageStateless(\r\n\t\twebsocket: WebSocket,\r\n\t\tmessage: WebsocketMessage\r\n\t) {\r\n\t\tconst onDelta = (chunk: string) =>\r\n\t\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\t\ttype: \"wb_stream_chunk\",\r\n\t\t\t\tdata: chunk,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t\tconversationID: message.conversationID,\r\n\t\t\t});\r\n\t\tconst response = await wbService.postMessageStateless(\r\n\t\t\tmessage.data,\r\n\t\t\tmessage.history,\r\n\t\t\tonDelta,\r\n\t\t\tmessage.systemPrompt\r\n\t\t);\r\n\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\ttype: \"wb_stream_end\",\r\n\t\t\tdata: response,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\tconversationID: message.conversationID,\r\n\t\t});\r\n\t}\r\n\r\n\tasync trackMoodChanges(websocket: WebSocket, message: WebsocketMessage) {\r\n\t\tconst onDelta = (chunk: string) =>\r\n\t\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\t\ttype: \"wb_stream_chunk\",\r\n\t\t\t\tdata: chunk,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t});\r\n\t\tconst response = await wbService.trackMoodChanges(\r\n\t\t\tmessage.userID,\r\n\t\t\tmessage.data,\r\n\t\t\tmessage.history,\r\n\t\t\tonDelta\r\n\t\t);\r\n\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\ttype: \"wb_stream_end\",\r\n\t\t\tdata: response,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t});\r\n\t}\r\n\r\n\tasync getUnbiasedOpinion(websocket: WebSocket, message: WebsocketMessage) {\r\n\t\tconst onDelta = (chunk: string) =>\r\n\t\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\t\ttype: \"wb_stream_chunk\",\r\n\t\t\t\tdata: chunk,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t});\r\n\t\tconst response = await wbService.getUnbiasedOpinion(\r\n\t\t\tmessage.data,\r\n\t\t\tonDelta\r\n\t\t);\r\n\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\ttype: \"wb_stream_end\",\r\n\t\t\tdata: response,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t});\r\n\t}\r\n\r\n\tasync dailyCheckIn(websocket: WebSocket, message: WebsocketMessage) {\r\n\t\tconst onDelta = (chunk: string) =>\r\n\t\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\t\ttype: \"wb_stream_chunk\",\r\n\t\t\t\tdata: chunk,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t});\r\n\t\tconst response = await wbService.dailyCheckIn(message.data, onDelta);\r\n\t\twebsocketService.sendToWS(websocket, {\r\n\t\t\ttype: \"wb_stream_end\",\r\n\t\t\tdata: response,\r\n\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t});\r\n\t}\r\n\r\n\thandleVideoCall(websocket: WebSocket, message: WebsocketMessage) {\r\n\t\tif (message.type === \"offer_video_call\") {\r\n\t\t\tchatService.offerVideoCall(\r\n\t\t\t\tmessage.data,\r\n\t\t\t\tmessage.targetUserID,\r\n\t\t\t\tmessage.chatID\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (message.type === \"answer_video_call\") {\r\n\t\t\tchatService.answerVideoCall(\r\n\t\t\t\tmessage.data,\r\n\t\t\t\tmessage.targetUserID,\r\n\t\t\t\tmessage.chatID\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (message.type === \"reject_video_call\") {\r\n\t\t\twebsocketService.sendTo(message.targetUserID, {\r\n\t\t\t\ttype: \"reject_video_call\",\r\n\t\t\t\tchatID: message.chatID,\r\n\t\t\t\ttargetUserID: message.targetUserID,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (message.type === \"establish_connection\") {\r\n\t\t\twebsocketService.sendTo(message.targetUserID, {\r\n\t\t\t\ttype: \"establish_connection\",\r\n\t\t\t\tdata: message.data,\r\n\t\t\t\tuserID: message.userID,\r\n\t\t\t\ttargetUserID: message.targetUserID,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (message.type === \"end_video_call\") {\r\n\t\t\twebsocketService.sendTo(message.targetUserID, {\r\n\t\t\t\ttype: \"end_video_call\",\r\n\t\t\t\ttargetUserID: message.targetUserID,\r\n\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst websocketController = new WebsocketController();\r\nexport default websocketController;\r\n"]}