{"version":3,"file":"wb.js","sourceRoot":"","sources":["../../services/wb.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,cAAc,EAAE,MAAM,iCAAiC,CAAC;AACjE,OAAO,EAAE,SAAS,EAAE,MAAM,yBAAyB,CAAC;AACpD,OAAO,cAAc,MAAM,iBAAiB,CAAC;AAC7C,OAAO,MAAM,MAAM,wBAAwB,CAAC;AAE5C,MAAM,SAAS;IACN,aAAa,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAmCvB,CAAC;IAEF,KAAK,CAAC,WAAW,CAChB,cAAsB,EACtB,IAGC,EACD,OAAgC;QAEhC,MAAM,YAAY,GAAG,MAAM,cAAc,CAAC,QAAQ,CACjD,cAAc,CACd,CAAC,IAAI,EAAE,CAAC;QAET,IAAI,CAAC,YAAY,EAAE,CAAC;YACnB,MAAM,IAAI,SAAS,CAClB,wBAAwB,EACxB,WAAW,EACX,cAAc,CAAC,QAAQ,CACvB,CAAC;QACH,CAAC;QACD,MAAM,OAAO,GAAG,YAAY,CAAC,QAAQ,CAAC;QACtC,YAAY,CAAC,QAAQ,CAAC,IAAI,CAAC;YAC1B,IAAI,EAAE,MAAM;YACZ,GAAG,IAAI;SACP,CAAC,CAAC;QACH,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,IAAI,CACjC,IAAI,CAAC,OAAO,EACZ,IAAI,CAAC,aAAa,EAClB,OAAO,EACP,OAAO,CACP,CAAC;QACF,YAAY,CAAC,QAAQ,CAAC,IAAI,CAAC;YAC1B,IAAI,EAAE,WAAW;YACjB,OAAO,EAAE,QAAQ;YACjB,SAAS,EAAE,IAAI,IAAI,EAAE;SACrB,CAAC,CAAC;QACH,MAAM,YAAY,CAAC,IAAI,EAAE,CAAC;QAE1B,OAAO,YAAY,CAAC;IACrB,CAAC;IAED,KAAK,CAAC,kBAAkB,CACvB,MAAc,EACd,IAGC;QAED,MAAM,cAAc,GAAG,MAAM,cAAc,CAAC,MAAM,CAAC;YAClD,IAAI,EAAE,MAAM;YACZ,QAAQ,EAAE,EAAE;SACZ,CAAC,CAAC;QACH,IAAI,IAAI,EAAE,CAAC;YACV,MAAM,KAAK,GAAG,MAAM,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAClD,cAAc,CAAC,KAAK,GAAG,KAAK,CAAC;QAC9B,CAAC;QACD,MAAM,cAAc,CAAC,IAAI,EAAE,CAAC;QAC5B,OAAO,cAAc,CAAC;IACvB,CAAC;CACD;AAED,MAAM,SAAS,GAAG,IAAI,SAAS,EAAE,CAAC;AAClC,eAAe,SAAS,CAAC","sourcesContent":["import { HttpStatusCode } from \"@common/constants/statusCode.js\";\r\nimport { HttpError } from \"../middlewares/error.js\";\r\nimport WBConversation from \"../models/wb.js\";\r\nimport openai from \"../utilities/openai.js\";\r\n\r\nclass WBService {\r\n\tprivate SYSTEM_PROMPT = `\r\n\t\tYou are \"Wellness Buddy\", an empathetic, professional wellness assistant embedded in the PSA Horizon website. \r\n\t\tSpeak in a warm, encouraging, and non-judgmental tone.\r\n\r\n\t\tPrimary goal:\r\n\t\t- Provide concise, practical, and actionable advice to help in mental wellness, mindfulness, stress management, mood tracking, and general wellbeing of PSA's employees.\r\n\r\n\t\tReply structure & style:\r\n\t\t- Start with a brief empathetic acknowledgement of the user's concern.\r\n\t\t- Then offer concise recommendations using numbered steps or a short checklist.\r\n\t\t- Try include a single-line \"Quick takeaway\" or \"Next steps\" at the end.\r\n\t\t- When giving exercises, include explicit, time-bound actions (e.g., \"Try box breathing: in 4s, hold 4s, out 4s, for 2 minutes\").\r\n\t\t- Use plain language, avoid jargon, and be culturally and racially inclusive.\r\n\r\n\t\tClarifying & tailoring behavior:\r\n\t\t- If missing any essential details, ask up to 1-2 focused clarifying questions before providing a tailored response.\r\n\t\t- If the user requests deeper analysis, ask permission to use any available tools/resources first.\r\n\r\n\t\tArtifacts:\r\n\t\t- When helpful, produce small artifacts (checklists, short 3-step plans, brief worksheets, or a 7-day micro-plan). Keep artifacts copy-friendly.\r\n\r\n\t\tTools & privacy:\r\n\t\t- If you need to access user files, web search, or external services (Google Drive, etc.), **request explicit permission first**, and state exactly what you'll access and why.\r\n\t\t- Do not request or store unnecessary sensitive personal data (IDs, full medical records, exact addresses). If the user shares sensitive information, advise removing identifying details.\r\n\r\n\t\tSafety & limits:\r\n\t\t- Do not provide medical diagnoses or professional clinical advice.\r\n\t\t- If the user expresses suicidal ideation, self-harm intent, or harm to others, respond with immediate empathy, clearly state you are not a crisis service, encourage contacting emergency services or crisis hotlines, and advise seeking urgent professional help. If possible, offer local emergency numbers if the user shares their country.\r\n\t\t- Be transparent about limitations: e.g., \"I'm not a clinician — for diagnosis or urgent help, please consult a professional.\"\r\n\r\n\t\tBrand alignment:\r\n\t\t- Keep language calm, competent, and friendly — reflective of PSA Horizon's professional audience.\r\n\t\t- Occasionally reference \"PSA Horizon\" or \"Wellness Buddy\" when it reinforces clarity or trust.\r\n\r\n\t\tDo not reveal internal reasoning. Keep user experience focused, safe, and action-oriented.\r\n\t`;\r\n\r\n\tasync postMessage(\r\n\t\tconversationId: string,\r\n\t\tdata: {\r\n\t\t\tcontent: string;\r\n\t\t\ttimestamp: Date;\r\n\t\t},\r\n\t\tonDelta: (chunk: string) => void\r\n\t) {\r\n\t\tconst conversation = await WBConversation.findById(\r\n\t\t\tconversationId\r\n\t\t).exec();\r\n\r\n\t\tif (!conversation) {\r\n\t\t\tthrow new HttpError(\r\n\t\t\t\t\"Conversation not found\",\r\n\t\t\t\t\"NOT_FOUND\",\r\n\t\t\t\tHttpStatusCode.NotFound\r\n\t\t\t);\r\n\t\t}\r\n\t\tconst history = conversation.messages;\r\n\t\tconversation.messages.push({\r\n\t\t\trole: \"user\",\r\n\t\t\t...data,\r\n\t\t});\r\n\t\tconst response = await openai.chat(\r\n\t\t\tdata.content,\r\n\t\t\tthis.SYSTEM_PROMPT,\r\n\t\t\thistory,\r\n\t\t\tonDelta\r\n\t\t);\r\n\t\tconversation.messages.push({\r\n\t\t\trole: \"assistant\",\r\n\t\t\tcontent: response,\r\n\t\t\ttimestamp: new Date(),\r\n\t\t});\r\n\t\tawait conversation.save();\r\n\r\n\t\treturn conversation;\r\n\t}\r\n\r\n\tasync createConversation(\r\n\t\tuserID: string,\r\n\t\tdata?: {\r\n\t\t\tcontent: string;\r\n\t\t\ttimestamp: Date;\r\n\t\t}\r\n\t) {\r\n\t\tconst wbConversation = await WBConversation.create({\r\n\t\t\tuser: userID,\r\n\t\t\tmessages: [],\r\n\t\t});\r\n\t\tif (data) {\r\n\t\t\tconst title = await openai.getTitle(data.content);\r\n\t\t\twbConversation.title = title;\r\n\t\t}\r\n\t\tawait wbConversation.save();\r\n\t\treturn wbConversation;\r\n\t}\r\n}\r\n\r\nconst wbService = new WBService();\r\nexport default wbService;\r\n"]}